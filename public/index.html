<!DOCTYPE html>

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.min.js"></script>
<script src="bundle.js"></script>

<script>
    // plugin startup shim
    var _pluginModule = require('pluginmain');
    
    // Global reference to the current sheet;
    var _plugin = null;
    // Well-known entry point, called by hosting infrastructure
    function PluginMain(sheetRef, opts) {
        _pluginModule.Blame.BrowserEntry(sheetRef, opts, function(plugin) {
            _plugin = plugin;
        });
    }

    function createOptions() {
        return {
            "recId": undefined,
            "gotoUrl": undefined,
            "container": document.getElementById("blame-container")
        };
    }
</script>
<!--<script src="https://trcanvasdata.blob.core.windows.net/code2/plugin.js"></script>-->
<!-- copied from "plugin.js" so I could modify it to pass "options" -->
<script>
    function LocalDebug() {
    $(function () {
        var elemDiv = document.createElement('div');
        elemDiv.innerHTML =
            '<div id="__debug_banner" style="background-color:lightyellow; border:dashed">' +
                '<h2>Self-hosted debugging</h2>' +
                '<p>View more documenation and samples at <a href="https://github.com/Voter-Science/TRC-API-Samples">https://github.com/Voter-Science/TRC-API-Samples</a></p>' +
                '<p>Enter your canvas code:</p>' +
                '<table>' +
                '<tr><td>Login URL</td><td><input size=80 type=text id="LocalDbgloginurl" value="https://trc-login.voter-science.com"/></td></tr>' +
                '<tr><td>Canvas code:</td><td><input type=text id="LocalDbgcode" placeholder="abc123" value="SGYZC4CH" /></td></tr>' +
                '</table>' +
                '<button onclick="LocalDebug_OnClick_AccessCodeAndLoadSheet()" value="Load">Load sheet!</button>' +
                '</div>';
        window.document.body.insertBefore(elemDiv, window.document.body.firstChild);
    });
}
function LocalDebug_OnClick_AccessCodeAndLoadSheet() {
    function _getErrorMsg(error) {
        try {
            var p2 = JSON.parse(error.responseText);
            return "(" + p2.Code + ") " + p2.Message;
        }
        catch (err) {
            return error.responseText;
        }
    }
    function trcPostLogin(loginUrl, canvasCode, successFunc) {
        var url = loginUrl + "/login/code2";
        var loginBody = {
            Code: canvasCode,
            AppName: "Demo"
        };
        $.support.cors = true;
        $.ajax({
            url: url,
            type: 'POST',
            contentType: "application/json",
            data: JSON.stringify(loginBody),
            success: function (sheetRef) {
                successFunc(sheetRef);
            },
            error: function (e1) {
                var msg = _getErrorMsg(e1);
                alert("Failed to do initial login at: " + loginUrl + " for code " + canvasCode + ": " + msg);
            }
        });
    }
    var loginUrl = $("#LocalDbgloginurl").val();
    var code = $("#LocalDbgcode").val();
    trcPostLogin(loginUrl, code, function (sheetRef) {
        $("#__debug_banner").hide();
        // BEGIN edit
        var opts = (createOptions && typeof createOptions === "function") ? createOptions() : undefined;
        // END edit
        PluginMain(sheetRef, opts);
    });
}
LocalDebug();
</script>


<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>TRC Blame Plugin</title>
</head>
<body>
    <div class="container">
        <div id="blame-container"></div>
    </div>
</body>
</html>